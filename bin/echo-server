#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDK_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
GO_HOLONS_DIR="${SDK_DIR}/../go-holons"
HELPER_PATH="${SDK_DIR}/cmd/echo-server-go/main.go"
PREFERRED_GO_BIN="/Users/bpds/go/go1.25.1/bin/go"

resolve_go_bin() {
  if [[ -n "${GO_BIN:-}" ]]; then
    printf '%s\n' "${GO_BIN}"
    return
  fi
  if [[ -x "${PREFERRED_GO_BIN}" ]]; then
    printf '%s\n' "${PREFERRED_GO_BIN}"
    return
  fi
  printf '%s\n' "go"
}

GO_CMD="$(resolve_go_bin)"
export GOCACHE="${GOCACHE:-/tmp/go-cache}"

cd "${GO_HOLONS_DIR}"

contains_flag() {
  local flag_name="$1"
  shift
  local arg
  for arg in "$@"; do
    if [[ "${arg}" == "${flag_name}" || "${arg}" == "${flag_name}="* ]]; then
      return 0
    fi
  done
  return 1
}

args=("$@")
if [[ "$#" -gt 0 && "$1" == "serve" ]]; then
  args=("serve" "${@:2}")
fi

if ! contains_flag "--sdk" "${args[@]}"; then
  args+=("--sdk" "java-holons")
fi

is_stdio_listen=0
for ((i=0; i<${#args[@]}; i++)); do
  arg="${args[$i]}"
  next_arg=""
  if (( i + 1 < ${#args[@]} )); then
    next_arg="${args[$((i + 1))]}"
  fi

  if [[ "${arg}" == "--listen" && ( "${next_arg}" == "stdio://" || "${next_arg}" == "stdio" ) ]]; then
    is_stdio_listen=1
    break
  fi
  if [[ "${arg}" == "--listen=stdio://" || "${arg}" == "--listen=stdio" ]]; then
    is_stdio_listen=1
    break
  fi
done

if [[ ${is_stdio_listen} -eq 1 ]]; then
  exec "${GO_CMD}" run "${HELPER_PATH}" "${args[@]}"
fi

select_target_pid() {
  local child_pid=""
  local attempt
  for attempt in $(seq 1 20); do
    child_pid="$(pgrep -P "${GO_PID}" | tail -n1 || true)"
    if [[ -n "${child_pid}" ]]; then
      printf '%s\n' "${child_pid}"
      return
    fi
    sleep 0.02
  done
  printf '%s\n' "${GO_PID}"
}

FORWARDED_SIGNAL=0
forward_signal() {
  local signal_name="$1"
  FORWARDED_SIGNAL=1

  if [[ -z "${GO_PID:-}" ]] || ! kill -0 "${GO_PID}" >/dev/null 2>&1; then
    return
  fi

  local target_pid
  target_pid="$(select_target_pid)"
  kill -"${signal_name}" "${target_pid}" >/dev/null 2>&1 || true
}

"${GO_CMD}" run "${HELPER_PATH}" "${args[@]}" &
GO_PID=$!

trap 'forward_signal TERM' TERM
trap 'forward_signal INT' INT

set +e
wait "${GO_PID}"
status=$?
set -e

trap - TERM
trap - INT

if [[ ${FORWARDED_SIGNAL} -eq 1 && ${status} -ge 128 ]]; then
  exit 0
fi

exit "${status}"
